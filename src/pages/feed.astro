---
import I18nKey from "@i18n/i18nKey";
import { i18n } from "@i18n/translation";
import MainGridLayout from "@layouts/MainGridLayout.astro";
import { getSortedPosts } from "@utils/content-utils";
import { formatDateToYYYYMMDD } from "@utils/date-utils";
import { getPostUrlBySlug } from "@utils/url-utils";
import { Icon } from "astro-icon/components";

const allPosts = (await getSortedPosts()).filter((post) => !post.data.draft);
const recentPosts = [...allPosts]
	.sort((a, b) => new Date(b.data.published) > new Date(a.data.published) ? 1 : -1)
	.slice(0, 3);
const atomUrl = `${Astro.site}atom.xml`;
const rssUrl = `${Astro.site}rss.xml`;
---

<MainGridLayout
	title={i18n(I18nKey.feed)}
	description={i18n(I18nKey.feedDescription)}
>
	<div class="card-base mb-6 px-6 md:px-9 py-6 md:py-8">
		<div class="text-center mb-6">
			<div class="inline-flex items-center justify-center w-14 h-14 bg-(--primary) rounded-xl mb-4">
				<Icon name="material-symbols:rss-feed" class="text-white text-2xl" />
			</div>
			<h1 class="text-3xl md:text-4xl font-bold text-90 mb-3">
				{i18n(I18nKey.feed)}
			</h1>
			<p class="text-75 max-w-2xl mx-auto">
				{i18n(I18nKey.feedSubtitle)}
			</p>
		</div>

		<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
			<div class="card-base p-4 md:p-5 transition">
				<div class="flex items-start gap-4 mb-4">
					<div class="shrink-0 w-12 h-12 bg-(--primary) rounded-xl flex items-center justify-center transition">
						<Icon name="material-symbols:rss-feed" class="text-white text-xl" />
					</div>
					<div class="flex-1 min-w-0">
						<h3 class="font-bold text-lg text-90 mb-1 transition">
							{i18n(I18nKey.feedRssLink)}
						</h3>
						<p class="text-sm text-75">{i18n(I18nKey.feedCopyToReader)}</p>
					</div>
				</div>
				<div class="flex flex-col sm:flex-row gap-3">
					<code
						class="flex-1 bg-(--btn-regular-bg) px-3 py-2 rounded-lg text-sm font-mono text-75 break-all transition"
					>
						{rssUrl}
					</code>
					<button
						class="copy-feed-btn btn-regular rounded-lg px-4 py-2 text-sm whitespace-nowrap"
						data-url={rssUrl}
					>
						{i18n(I18nKey.feedCopyLink)}
					</button>
				</div>
			</div>

			<div class="card-base p-4 md:p-5 transition">
				<div class="flex items-start gap-4 mb-4">
					<div class="shrink-0 w-12 h-12 bg-(--primary) rounded-xl flex items-center justify-center transition">
						<Icon name="material-symbols:link" class="text-white text-xl" />
					</div>
					<div class="flex-1 min-w-0">
						<h3 class="font-bold text-lg text-90 mb-1 transition">
							{i18n(I18nKey.feedAtomLink)}
						</h3>
						<p class="text-sm text-75">{i18n(I18nKey.feedCopyToReader)}</p>
					</div>
				</div>
				<div class="flex flex-col sm:flex-row gap-3">
					<code
						class="flex-1 bg-(--btn-regular-bg) px-3 py-2 rounded-lg text-sm font-mono text-75 break-all transition"
					>
						{atomUrl}
					</code>
					<button
						class="copy-feed-btn btn-regular rounded-lg px-4 py-2 text-sm whitespace-nowrap"
						data-url={atomUrl}
					>
						{i18n(I18nKey.feedCopyLink)}
					</button>
				</div>
			</div>
		</div>
	</div>

	<div class="card-base mb-6 px-6 md:px-9 py-6 md:py-8">
		<h2 class="text-xl font-bold text-90 mb-4 flex items-center">
			<Icon name="material-symbols:article" class="mr-2 text-(--primary)" />
			{i18n(I18nKey.feedLatestPosts)}
		</h2>
		<div class="space-y-3">
			{recentPosts.map((post, index) => (
				<a
					href={getPostUrlBySlug(post.slug)}
					class="group block card-base p-4 rounded-xl transition onload-animation"
					style={`animation-delay: ${index * 50}ms`}
				>
					<h3 class="font-bold text-lg text-90 mb-2 transition group-hover:text-(--primary) line-clamp-1">
						{post.data.title}
					</h3>
					{post.data.description && (
						<p class="text-75 mb-2 line-clamp-2">{post.data.description}</p>
					)}
					<div class="text-sm text-60">
						<time datetime={post.data.published.toISOString()} class="text-75">
							{formatDateToYYYYMMDD(post.data.published)}
						</time>
					</div>
				</a>
			))}
		</div>
	</div>
</MainGridLayout>

<script is:inline define:vars={{ copySuccess: i18n(I18nKey.feedCopySuccess), copyLink: i18n(I18nKey.feedCopyLink) }}>
	document.querySelectorAll(".copy-feed-btn").forEach((btn) => {
		btn.addEventListener("click", function () {
			navigator.clipboard.writeText(this.getAttribute("data-url")).then(() => {
				this.textContent = copySuccess;
				setTimeout(() => {
					this.textContent = copyLink;
				}, 1000);
			});
		});
	});
</script>
