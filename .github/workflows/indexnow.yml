name: IndexNow Submit
on:
  push:
    paths:
      - "src/content/posts/**"

jobs:
  indexnow:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Generate and submit URLs to IndexNow
        run: |
          URLS=$(git diff --name-only HEAD~1 HEAD -- 'src/content/posts/**' | \
            while read file; do
              [ -f "$file" ] && ! awk '/^---$/{n++} n==1; n==2{exit}' "$file" | grep -q '^draft: true' && \
                echo "$file" | sed 's|src/content/posts/||; s|\.md$||' | \
                xargs -I{} echo "https://yamr.cc/posts/{}/"
            done | jq -R -s -c 'split("\n") | map(select(. != ""))')

          echo "Generated URLs: $URLS"

          if [ "$URLS" != "[]" ]; then
            JSON_DATA=$(jq -n \
              --arg host "yamr.cc" \
              --arg key "cea6fbbfcc7f40ce8972501dcc968155" \
              --arg keyLocation "https://yamr.cc/indexnow.txt" \
              --argjson urlList "$URLS" \
              '{host: $host, key: $key, keyLocation: $keyLocation, urlList: $urlList}')

            echo "Payload: $JSON_DATA"

            curl -i -X POST "https://bing.com/indexnow" \
              -H "Content-Type: application/json" \
              -d "$JSON_DATA"
          else
            echo "No URLs to submit"
          fi
